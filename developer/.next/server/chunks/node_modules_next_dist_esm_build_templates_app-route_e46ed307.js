module.exports=[61578,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),i=e.i(59756),a=e.i(61916),s=e.i(14444),o=e.i(37092),l=e.i(69741),d=e.i(16795),c=e.i(87718),u=e.i(95169),p=e.i(47587),_=e.i(66012),h=e.i(70101),f=e.i(26937),v=e.i(10372),R=e.i(93695);e.i(52474);var w=e.i(5232),x=e.i(89171),g=e.i(87464),m=e.i(54799),E=e.i(24652);function k(e,t=3600){let r=process.env.JWT_SECRET||process.env.SUPABASE_JWT_SECRET||"dev-secret";return E.default.sign(e,r,{expiresIn:t,algorithm:"HS256"})}function N(){return`cw_rt_${m.default.randomBytes(32).toString("hex")}`}function S(e){return m.default.createHash("sha256").update(e).digest("hex")}async function y(e){try{let t;if((e.headers.get("content-type")||"").includes("application/x-www-form-urlencoded")){let r=await e.formData();t=Object.fromEntries(r.entries())}else t=await e.json();let r=t.grant_type,n=(()=>{let e="https://kbyeiqzxuaslqquhpyvi.supabase.co",t=process.env.DEV_SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase admin credentials not configured");return(0,g.createClient)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})})();switch(r){case"authorization_code":return C(t,n);case"refresh_token":return A(t,n);case"client_credentials":return D(t,n);default:return x.NextResponse.json({error:"unsupported_grant_type",error_description:`Grant type '${r}' is not supported`},{status:400})}}catch(e){return console.error("OAuth token error:",e),x.NextResponse.json({error:"server_error",error_description:e.message||"Internal server error"},{status:500})}}async function C(e,t){let{code:r,client_id:n,client_secret:i,redirect_uri:a,code_verifier:s}=e;if(!r||!n)return x.NextResponse.json({error:"invalid_request",error_description:"Missing required parameters"},{status:400});let{data:o,error:l}=await t.from("oauth_authorization_codes").select("*, application:developer_applications(*)").eq("code",r).single();if(l||!o)return x.NextResponse.json({error:"invalid_grant",error_description:"Invalid or expired authorization code"},{status:400});if(new Date(o.expires_at)<new Date)return await t.from("oauth_authorization_codes").delete().eq("code",r),x.NextResponse.json({error:"invalid_grant",error_description:"Authorization code has expired"},{status:400});if(o.used_at)return await t.from("oauth_access_tokens").update({is_revoked:!0}).eq("authorization_code",r),x.NextResponse.json({error:"invalid_grant",error_description:"Authorization code has already been used"},{status:400});let d=o.application;if(d.client_id!==n)return x.NextResponse.json({error:"invalid_client",error_description:"Client ID mismatch"},{status:401});if(a&&a!==o.redirect_uri)return x.NextResponse.json({error:"invalid_grant",error_description:"Redirect URI mismatch"},{status:400});if(o.code_challenge){var c;if(!s)return x.NextResponse.json({error:"invalid_request",error_description:"Code verifier required for PKCE"},{status:400});if(c=o.code_challenge,"S256"===(o.code_challenge_method||"plain")?m.default.createHash("sha256").update(s).digest("base64url")!==c:s!==c)return x.NextResponse.json({error:"invalid_grant",error_description:"Code verifier verification failed"},{status:400})}else if(i){let e=S(i);if(d.client_secret_hash!==e&&(!d.previous_client_secret_hash||d.previous_client_secret_hash!==e||new Date(d.previous_secret_expires_at)<new Date))return x.NextResponse.json({error:"invalid_client",error_description:"Invalid client credentials"},{status:401})}await t.from("oauth_authorization_codes").update({used_at:new Date().toISOString()}).eq("code",r);let{data:u}=await t.from("profiles").select("*").eq("user_id",o.user_id).single(),p=k({sub:o.user_id,aud:d.client_id,app_id:d.id,scopes:o.scopes,iss:"catalystwells",iat:Math.floor(Date.now()/1e3)},3600),_=N(),h=new Date(Date.now()+2592e6);await t.from("oauth_refresh_tokens").insert({token_hash:S(_),application_id:d.id,user_id:o.user_id,scopes:o.scopes,expires_at:h.toISOString()}),await t.from("oauth_access_tokens").insert({token_hash:S(p),application_id:d.id,user_id:o.user_id,scopes:o.scopes,authorization_code:r,expires_at:new Date(Date.now()+36e5).toISOString()}),await t.rpc("increment_token_exchanges",{app_id:d.id}).catch(()=>{});let f={access_token:p,token_type:"Bearer",expires_in:3600,refresh_token:_,scope:o.scopes.join(" ")};return o.scopes.includes("openid")&&(f.id_token=k({sub:o.user_id,aud:d.client_id,iss:"catalystwells",iat:Math.floor(Date.now()/1e3),exp:Math.floor(Date.now()/1e3)+3600,email:u?.email,name:u?.full_name,picture:u?.avatar_url})),x.NextResponse.json(f)}async function A(e,t){let{refresh_token:r,client_id:n,client_secret:i,scope:a}=e;if(!r||!n)return x.NextResponse.json({error:"invalid_request",error_description:"Missing required parameters"},{status:400});let s=S(r),{data:o,error:l}=await t.from("oauth_refresh_tokens").select("*, application:developer_applications(*)").eq("token_hash",s).eq("is_revoked",!1).single();if(l||!o)return x.NextResponse.json({error:"invalid_grant",error_description:"Invalid or expired refresh token"},{status:400});if(new Date(o.expires_at)<new Date)return await t.from("oauth_refresh_tokens").update({is_revoked:!0}).eq("token_hash",s),x.NextResponse.json({error:"invalid_grant",error_description:"Refresh token has expired"},{status:400});let d=o.application;if(d.client_id!==n)return x.NextResponse.json({error:"invalid_client",error_description:"Client ID mismatch"},{status:401});if(i){let e=S(i);if(d.client_secret_hash!==e)return x.NextResponse.json({error:"invalid_client",error_description:"Invalid client credentials"},{status:401})}let c=o.scopes;if(a){let e=a.split(" ").filter(Boolean);if(e.filter(e=>!o.scopes.includes(e)).length>0)return x.NextResponse.json({error:"invalid_scope",error_description:"Cannot request scopes not in original grant"},{status:400});c=e}let u=k({sub:o.user_id,aud:d.client_id,app_id:d.id,scopes:c,iss:"catalystwells",iat:Math.floor(Date.now()/1e3)},3600),p=r;if("true"===process.env.ROTATE_REFRESH_TOKENS){p=N(),await t.from("oauth_refresh_tokens").update({is_revoked:!0}).eq("token_hash",s);let e=new Date(Date.now()+2592e6);await t.from("oauth_refresh_tokens").insert({token_hash:S(p),application_id:d.id,user_id:o.user_id,scopes:c,expires_at:e.toISOString()})}return await t.from("oauth_access_tokens").insert({token_hash:S(u),application_id:d.id,user_id:o.user_id,scopes:c,expires_at:new Date(Date.now()+36e5).toISOString()}),await t.rpc("increment_token_refreshes",{app_id:d.id}).catch(()=>{}),x.NextResponse.json({access_token:u,token_type:"Bearer",expires_in:3600,refresh_token:p,scope:c.join(" ")})}async function D(e,t){let{client_id:r,client_secret:n,scope:i}=e;if(!r||!n)return x.NextResponse.json({error:"invalid_request",error_description:"Missing client credentials"},{status:400});let{data:a}=await t.from("developer_applications").select("*").eq("client_id",r).single();if(!a)return x.NextResponse.json({error:"invalid_client",error_description:"Unknown client_id"},{status:401});let s=S(n);if(a.client_secret_hash!==s)return x.NextResponse.json({error:"invalid_client",error_description:"Invalid client credentials"},{status:401});if("approved"!==a.status)return x.NextResponse.json({error:"unauthorized_client",error_description:"Application is not approved"},{status:403});let o=i?i.split(" ").filter(Boolean):[],l=a.allowed_scopes||[],d=o.filter(e=>l.includes(e)&&!e.startsWith("user.")),c=k({sub:`app:${a.id}`,aud:a.client_id,app_id:a.id,scopes:d,iss:"catalystwells",iat:Math.floor(Date.now()/1e3),grant_type:"client_credentials"},3600);return x.NextResponse.json({access_token:c,token_type:"Bearer",expires_in:3600,scope:d.join(" ")})}e.s(["POST",()=>y],55589);var j=e.i(55589);let q=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/oauth/token/route",pathname:"/api/oauth/token",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/developer/src/app/api/oauth/token/route.ts",nextConfigOutput:"",userland:j}),{workAsyncStorage:O,workUnitAsyncStorage:T,serverHooks:I}=q;function b(){return(0,n.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:T})}async function P(e,t,n){q.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/oauth/token/route";x=x.replace(/\/index$/,"")||"/";let g=await q.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!g)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:m,params:E,nextConfig:k,parsedUrl:N,isDraftMode:S,prerenderManifest:y,routerServerContext:C,isOnDemandRevalidate:A,revalidateOnlyGenerated:D,resolvedPathname:j,clientReferenceManifest:O,serverActionsManifest:T}=g,I=(0,l.normalizeAppPath)(x),b=!!(y.dynamicRoutes[I]||y.routes[j]),P=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,N,!1):t.end("This page could not be found"),null);if(b&&!S){let e=!!y.routes[j],t=y.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(k.experimental.adapterPath)return await P();throw new R.NoFallbackError}}let M=null;!b||q.isDev||S||(M="/index"===(M=j)?"/":M);let H=!0===q.isDev||!b,U=b&&!H;T&&O&&(0,s.setReferenceManifestsSingleton)({page:x,clientReferenceManifest:O,serverActionsManifest:T,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:T})});let B=e.method||"GET",z=(0,a.getTracer)(),K=z.getActiveScopeSpan(),$={params:E,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!k.experimental.authInterrupts},cacheComponents:!!k.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:k.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>q.onRequestError(e,t,n,C)},sharedContext:{buildId:m}},F=new d.NodeNextRequest(e),L=new d.NodeNextResponse(t),V=c.NextRequestAdapter.fromNodeNextRequest(F,(0,c.signalFromNodeResponse)(t));try{let s=async e=>q.handle(V,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=z.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${B} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${x}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var a,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&A&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(i);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!b)return await (0,_.sendResponse)(F,L,a,$.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[v.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,n=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})},C),t}},c=await q.handleResponse({req:e,nextConfig:k,cacheKey:M,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:D,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:o});if(!b)return null;if((null==c||null==(a=c.value)?void 0:a.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&b||u.delete(v.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,_.sendResponse)(F,L,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};K?await l(K):await z.withPropagatedContext(e.headers,()=>z.trace(u.BaseServerSpan.handleRequest,{spanName:`${B} ${x}`,kind:a.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},l))}catch(t){if(t instanceof R.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})}),b)throw t;return await (0,_.sendResponse)(F,L,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>b,"routeModule",()=>q,"serverHooks",()=>I,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>T],61578)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e46ed307.js.map